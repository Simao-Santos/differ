image: gitlab/dind
 
include:
  - template: Security/Dependency-Scanning.gitlab-ci.yml
  - template: Security/License-Scanning.gitlab-ci.yml
  - template: Security/SAST.gitlab-ci.yml
  - template: Security/Secret-Detection.gitlab-ci.yml
 
services:
  - docker:dind
 
stages:
  - lint
  - build
  - test
  - deploy
 
# run eslint and attempt to fix the linting erros (in front end)
# eslint-frontend:
#   stage: lint
#   image: registry.gitlab.com/feup-tbs/ldso2021/t1g1:frontend
#   script:
#     - cd fe/
#     - npm install eslint --save-dev
#     - npm run lint-fix
 
# # run eslint and attempt to fix the linting erros (in backend)
# eslint-backend:
#   stage: lint
#   image: registry.gitlab.com/feup-tbs/ldso2021/t1g1:backend
#   script:
#     - cd be/
#     - npm install eslint --save-dev
#     - npm run lint-fix
 
 
 
# # builds the express backend (I think)
# build_express:
#   stage: build
#   image: registry.gitlab.com/feup-tbs/ldso2021/t1g1:backend
#   script:
#     - echo "Start building Backend"
#     - cd be/
#     - npm install
#     - echo "Build successful!"
 
# # builds the react frontend (I think)
# build_react:
#   stage: build
#   image: registry.gitlab.com/feup-tbs/ldso2021/t1g1:frontend
#   script:
#     - echo "Start building Frontend"
#     - cd fe/
#     - npm install
#     - npm run build
#     - echo "Build successful!"
 
# build_back_end:
#     stage: build
#     script:
#       - cd be/
#       - docker version
#       - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN registry.gitlab.com
#       - docker build -t registry.gitlab.com/feup-tbs/ldso2021/t1g1:backend .
#       - docker push registry.gitlab.com/feup-tbs/ldso2021/t1g1
 
# build_front_end:
#     stage: build
#     script:
#       - cd fe/
#       - docker version
#       - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN registry.gitlab.com
#       - docker build -t registry.gitlab.com/feup-tbs/ldso2021/t1g1:frontend .
#       - docker push registry.gitlab.com/feup-tbs/ldso2021/t1g1

# build_mlg:
#     stage: build
#     script:
#     - docker version
#     - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN registry.gitlab.com
#     - docker build -f Dockerfile.web -t registry.gitlab.com/feup-tbs/ldso2021/t1g1 .
#     - docker push registry.gitlab.com/feup-tbs/ldso2021/t1g1

deploy_mlg:
    stage: deploy
    
deploy_production:
    stage: deploy
    only:
      - master
    script:
      - dpl --provider=heroku --app=t1g1-production --api-key=$HEROKU_API_KEY

# # tests the express backend (I think)
# test_express:
#   stage: test
#   image: node
#   script:
#     - echo "Testing App"
#     - npm install
#     - CI=true npm test
#     - echo "Test successfully!"