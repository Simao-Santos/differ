image: gitlab/dind
 
include:
  - template: Security/Dependency-Scanning.gitlab-ci.yml
  - template: Security/License-Scanning.gitlab-ci.yml
  - template: Security/SAST.gitlab-ci.yml
  - template: Security/Secret-Detection.gitlab-ci.yml
 
services:
  - docker:dind
 
stages:
  - lint
  - build
  - test
  - deploy
 
# #run eslint and attempt to fix the linting erros (in front end)
# eslint-frontend:
#   stage: lint
#   image: registry.gitlab.com/feup-tbs/ldso2021/t1g1-develop:frontend
#   script:
#     - ls
#     - cd fe/
#     - ls
#     - npm install eslint --save-dev
#     - npm run lint-fix
 
# # run eslint and attempt to fix the linting erros (in backend)
# eslint-backend:
#   stage: lint
#   image: registry.gitlab.com/feup-tbs/ldso2021/t1g1-develop:backend
#   script:
#     - cd be/
#     - npm install eslint --save-dev
#     - npm run lint-fix
 
 
 
build_backend:
    stage: build
    script:
      - cd be/
      - docker version
      - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN registry.gitlab.com
      - docker build -t registry.gitlab.com/feup-tbs/ldso2021/t1g1-develop:backend .
      - docker push registry.gitlab.com/feup-tbs/ldso2021/t1g1-develop
 
build_frontend:
    stage: build
    script:
      - cd fe/
      - docker version
      - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN registry.gitlab.com
      - docker build -t registry.gitlab.com/feup-tbs/ldso2021/t1g1-develop:frontend .
      - docker push registry.gitlab.com/feup-tbs/ldso2021/t1g1-develop


build_backend_production:
    stage: build
    only: 
      - master
    script:
      - cd be/
      - docker version
      - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN registry.gitlab.com
      - docker build -t registry.gitlab.com/feup-tbs/ldso2021/t1g1-production:backend .
      - docker push registry.gitlab.com/feup-tbs/ldso2021/t1g1-production
      
 
build_frontend_production:
    stage: build
    only: 
      - master
    script:
      - cd fe/
      - docker version
      - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN registry.gitlab.com
      - docker build -t registry.gitlab.com/feup-tbs/ldso2021/t1g1-production:frontend .
      - docker push registry.gitlab.com/feup-tbs/ldso2021/t1g1-production


# build_mlg:
#     stage: build
#     script:
#     - docker version
#     - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN registry.gitlab.com
#     - docker build -f Dockerfile.web -t registry.gitlab.com/feup-tbs/ldso2021/t1g1 .
#     - docker push registry.gitlab.com/feup-tbs/ldso2021/t1g1



# # tests the express backend (I think)
# test_express:
#   stage: test
#   image: node
#   script:
#     - echo "Testing App"
#     - npm install
#     - CI=true npm test
#     - echo "Test successfully!"